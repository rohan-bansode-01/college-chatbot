<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reset Password</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Inter',sans-serif;
}

body{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,#020617,#0f172a,#020617);
  padding:20px;
}

/* Card */
.card{
  width:100%;
  max-width:380px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:20px;
  padding:30px;
  backdrop-filter:blur(20px);
  color:white;
}

/* Title */
h2{
  text-align:center;
  margin-bottom:6px;
}
.subtitle{
  text-align:center;
  font-size:13px;
  opacity:.7;
  margin-bottom:20px;
}

/* Steps */
.steps{
  display:flex;
  justify-content:space-between;
  margin-bottom:20px;
}

.step{
  flex:1;
  text-align:center;
  font-size:12px;
  opacity:.4;
}

.step.active{
  opacity:1;
  font-weight:600;
  color:#60a5fa;
}

/* Inputs */
input{
  width:100%;
  padding:14px;
  margin-bottom:12px;
  border-radius:12px;
  border:none;
  outline:none;
  font-size:15px;
}

/* Buttons */
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,#2563eb,#3b82f6);
  color:white;
  font-weight:600;
  cursor:pointer;
  font-size:15px;
  transition:.2s;
}

button:hover{
  transform:translateY(-1px);
}

/* Message */
#msg{
  margin-top:12px;
  text-align:center;
  font-size:13px;
}

/* Sections */
.section{ display:none; }
.section.active{ display:block; }

/* Strength */
.strength{
  height:6px;
  background:rgba(255,255,255,.2);
  border-radius:6px;
  overflow:hidden;
  margin-bottom:8px;
}

.strength-fill{
  height:100%;
  width:0%;
  transition:.3s;
}

.weak{ background:#ef4444; width:33%; }
.medium{ background:#facc15; width:66%; }
.strong{ background:#22c55e; width:100%; }

.strength-text{
  font-size:12px;
  margin-bottom:10px;
}

/* Recaptcha spacing */
#recaptcha-container{
  margin:12px 0;
}
</style>
</head>
<body>

<div class="card">

  <h2>Reset Password</h2>
  <div class="subtitle">Secure OTP verification</div>

  <div class="steps">
    <div class="step active" id="s1">1. Phone</div>
    <div class="step" id="s2">2. OTP</div>
    <div class="step" id="s3">3. New Password</div>
  </div>

  <!-- PHONE -->
  <div id="phoneBox" class="section active">
    <input type="text" id="phone" placeholder="Enter phone number">
    <div id="recaptcha-container"></div>
    <button onclick="sendOTP()">Send OTP</button>
  </div>

  <!-- OTP -->
  <div id="otpBox" class="section">
    <input type="text" id="otp" placeholder="Enter 6-digit OTP" maxlength="6">
    <button onclick="verifyOTP()">Verify OTP</button>
  </div>

  <!-- PASSWORD -->
  <div id="passBox" class="section">
    <input type="password" id="newpass" placeholder="New Password">

    <div class="strength">
      <div id="strengthFill" class="strength-fill"></div>
    </div>
    <div id="strengthText" class="strength-text"></div>

    <button onclick="changePassword()">Update Password</button>
  </div>

  <div id="msg"></div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDLepAVQYijhcs0dOyH0gZS38iUtH_BbvA",
  authDomain: "college-chatbot-c9e6c.firebaseapp.com",
  projectId: "college-chatbot-c9e6c"
});
const auth = firebase.auth();

/* RECAPTCHA */
window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
  'recaptcha-container',{size:'normal'}
);
recaptchaVerifier.render();

let confirmationResult;
const msgBox = document.getElementById("msg");

/* Step UI */
function setStep(n){
  document.getElementById("s1").classList.toggle("active", n===1);
  document.getElementById("s2").classList.toggle("active", n===2);
  document.getElementById("s3").classList.toggle("active", n===3);

  phoneBox.classList.toggle("active", n===1);
  otpBox.classList.toggle("active", n===2);
  passBox.classList.toggle("active", n===3);
}

/* SEND OTP */
function sendOTP(){
  let phone = document.getElementById("phone").value.trim();
  if(phone.match(/^\d{10}$/)) phone = "+91" + phone;

  if(!phone.match(/^\+\d{10,15}$/)){
    msgBox.innerText = "Enter valid phone number";
    return;
  }

  auth.signInWithPhoneNumber(phone, window.recaptchaVerifier)
  .then(res=>{
    confirmationResult = res;
    setStep(2);
    msgBox.innerText = "OTP sent to your phone";
  })
  .catch(e=> msgBox.innerText = e.message);
}

/* OTP only numbers */
const otpInput = document.getElementById("otp");
otpInput.addEventListener("input", ()=>{
  otpInput.value = otpInput.value.replace(/[^0-9]/g,"");
});

/* VERIFY OTP */
function verifyOTP(){
  const otp = otpInput.value.trim();
  if(otp.length !== 6){
    msgBox.innerText = "Enter 6 digit OTP";
    return;
  }

  confirmationResult.confirm(otp)
  .then(()=>{
    setStep(3);
    msgBox.innerText = "OTP verified";
  })
  .catch(()=> msgBox.innerText = "Invalid OTP");
}

/* PASSWORD STRENGTH */
const passInput = document.getElementById("newpass");
const fill = document.getElementById("strengthFill");
const strengthText = document.getElementById("strengthText");

passInput.addEventListener("input", ()=>{
  let v = passInput.value;
  let s = 0;
  if(v.length >= 8) s++;
  if(/[a-z]/.test(v)) s++;
  if(/[A-Z]/.test(v)) s++;
  if(/[0-9]/.test(v)) s++;
  if(/[\W]/.test(v)) s++;

  if(s <= 2){
    fill.className = "strength-fill weak";
    strengthText.innerText = "Weak password";
  } else if(s <= 4){
    fill.className = "strength-fill medium";
    strengthText.innerText = "Medium strength";
  } else {
    fill.className = "strength-fill strong";
    strengthText.innerText = "Strong password";
  }
});

/* CHANGE PASSWORD */
function changePassword(){
  const pass = passInput.value.trim();
  if(pass.length < 8){
    msgBox.innerText = "Password must be at least 8 characters";
    return;
  }

  fetch("/reset_password",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      phone: document.getElementById("phone").value.trim(),
      password: pass
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      msgBox.innerText = "Password updated successfully!";
      setTimeout(()=> location.href="/login", 2000);
    } else {
      msgBox.innerText = d.msg || "Update failed";
    }
  })
  .catch(()=> msgBox.innerText = "Server error");
}
</script>

</body>
</html>
